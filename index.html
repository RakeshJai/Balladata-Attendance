<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Attendance PWA</title>

  <!-- Material Design Lite -->
  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
  <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

  <!-- Google Identity & API -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>

  <style>
    body { font-family: 'Roboto', sans-serif; background: #f5f5f5; }
    .page-content { padding: 20px; max-width: 800px; margin: auto; }
    .student-card { margin: 10px 0; padding: 15px; background: white; border-radius: 8px; box-shadow:0 2px 6px rgba(0,0,0,0.1);}
    .mdl-radio { margin-right: 10px; }
    .submit-btn { margin-top: 20px; width: 100%; }
    .student-name { font-weight: bold; margin-bottom: 10px; display: block; }
    #statusMessage { margin: 10px 0; font-weight: bold; }
  </style>
</head>
<body>
  <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
    <header class="mdl-layout__header">
      <div class="mdl-layout__header-row">
        <span class="mdl-layout-title">Attendance System</span>
      </div>
    </header>
    <main class="mdl-layout__content">
      <div class="page-content">

        <button id="loginBtn" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
          Sign in with Google
        </button>

        <div id="attendanceSection" style="display:none;">
          <p>Logged in as: <span id="teacherNameDisplay"></span></p>
          <h4>Mark Attendance</h4>
          <div id="statusMessage"></div>
          <div id="studentList"></div>
          <button id="submitBtn" class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent submit-btn">
            Submit Attendance
          </button>
        </div>
      </div>
    </main>
  </div>

  <script>
    const CLIENT_ID = "1062324886633-brv79jb9smbkrpd9iuvtj5galvhbqfqh.apps.googleusercontent.com";
    const SPREADSHEET_ID = "1qnNF6HZXxWksMjJ-Z06Ovk64CWMvXFHeTieaTi8xZ5M";
    const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

    // For testing: pick a level
    const TEACHER_LEVEL = "Level1";

    let tokenClient;
    let attendance = {};
    let teacherName = "";

    gapi.load("client", async () => {
      await gapi.client.init({
        discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
      });
    });

    window.onload = () => {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: async (resp) => {
          if (resp.error !== undefined) {
            console.error(resp);
            showStatus("OAuth Error", false);
            return;
          }

          // You can decode JWT to get real name/email
          teacherName = "Teacher";
          document.getElementById("teacherNameDisplay").textContent = teacherName;

          document.getElementById("attendanceSection").style.display = "block";
          document.getElementById("loginBtn").style.display = "none";

          await loadStudents();
        },
      });

      document.getElementById("loginBtn").onclick = () => {
        tokenClient.requestAccessToken({ prompt: "consent" });
      };

      document.getElementById("submitBtn").onclick = submitAttendance;
    };

    async function loadStudents() {
      try {
        const response = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: `${TEACHER_LEVEL}!A2:A`,
        });

        const students = response.result.values ? response.result.values.flat() : [];
        renderStudents(students);
      } catch (err) {
        console.error("Error loading students:", err);
        showStatus("Error loading students", false);
      }
    }

    function renderStudents(students) {
      const listDiv = document.getElementById("studentList");
      listDiv.innerHTML = "";

      students.forEach((student) => {
        attendance[student] = "Absent"; // default

        const div = document.createElement("div");
        div.className = "student-card mdl-shadow--2dp";

        const radios = `
          <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="present-${student}">
            <input type="radio" id="present-${student}" class="mdl-radio__button" name="${student}" value="Present"
              onchange="mark('${student}', 'Present')" />
            <span class="mdl-radio__label">Present</span>
          </label>
          <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="absent-${student}">
            <input type="radio" id="absent-${student}" class="mdl-radio__button" name="${student}" value="Absent"
              checked onchange="mark('${student}', 'Absent')" />
            <span class="mdl-radio__label">Absent</span>
          </label>
        `;

        div.innerHTML = `<span class="student-name">${student}</span><div>${radios}</div>`;
        listDiv.appendChild(div);
        componentHandler.upgradeElements(div);
      });
    }

    function mark(student, status) {
      attendance[student] = status;
    }

    function showStatus(msg, success=true) {
      const status = document.getElementById("statusMessage");
      status.textContent = msg;
      status.style.color = success ? "green" : "red";
      setTimeout(() => { status.textContent = ""; }, 3000);
    }

    async function submitAttendance() {
      try {
        const students = Object.keys(attendance);
        for (let i = 0; i < students.length; i++) {
          const student = students[i];
          await gapi.client.sheets.spreadsheets.values.update({
            spreadsheetId: SPREADSHEET_ID,
            range: `${TEACHER_LEVEL}!B${i+2}`,
            valueInputOption: "RAW",
            resource: { values: [[attendance[student]]] },
          });
        }
        showStatus("Attendance submitted!");
      } catch (err) {
        console.error(err);
        showStatus("Error submitting attendance", false);
      }
    }
  </script>
</body>
</html>
