<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Attendance System</title>

  <!-- Material Design Lite -->
  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
  <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

  <!-- Google Identity & API -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>

  <style>
    :root {
      --bg-color: #121212;
      --card-color: #1e1e1e;
      --text-color: #ffffff;
      --accent-color: #bb86fc;
      --error-color: #cf6679;
    }

    body {
      background-color: var(--bg-color);
      color: var(--text-color);
      font-family: 'Roboto', sans-serif;
      margin: 0;
    }

    header.mdl-layout__header {
      background-color: #000;
      color: white;
      box-shadow: none;
      border-bottom: 1px solid #333;
    }

    .page-content {
      padding: 20px;
      max-width: 800px;
      margin: 0 auto;
      text-align: center;
    }

    .mdl-button--colored, .mdl-button--accent {
      background-color: var(--accent-color) !important;
      color: #000 !important;
    }

    .mdl-button--raised {
      border-radius: 8px;
      text-transform: none;
    }

    .student-card {
      background-color: var(--card-color);
      color: var(--text-color);
      padding: 15px;
      margin: 10px 0;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(255, 255, 255, 0.05);
      transition: transform 0.2s ease;
    }

    .student-card:hover {
      transform: translateY(-3px);
    }

    .mdl-radio__label {
      color: var(--text-color);
    }

    .level-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 15px;
      margin-top: 20px;
    }

    .level-btn {
      background-color: var(--card-color);
      color: var(--text-color);
      border: 1px solid #333;
      padding: 15px;
      border-radius: 10px;
      cursor: pointer;
      font-size: 16px;
      transition: all 0.2s ease;
    }

    .level-btn:hover {
      background-color: var(--accent-color);
      color: #000;
      transform: translateY(-3px);
    }

    #statusMessage {
      font-weight: bold;
      margin: 10px 0;
    }

    #backBtn {
      margin-top: 10px;
      background-color: #333 !important;
      color: #fff !important;
    }

    #backBtn:hover {
      background-color: #444 !important;
    }

    .fade {
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
    <header class="mdl-layout__header">
      <div class="mdl-layout__header-row">
        <span class="mdl-layout-title">Attendance System</span>
      </div>
    </header>
    <main class="mdl-layout__content">
      <div class="page-content fade">

        <!-- LOGIN -->
        <button id="loginBtn" class="mdl-button mdl-js-button mdl-button--raised mdl-button--colored">
          Sign in with Google
        </button>

        <!-- LEVEL SELECTOR -->
        <div id="levelSelector" style="display:none;">
          <p>Welcome, <span id="teacherNameDisplay"></span></p>
          <h4>Select Level</h4>
          <div class="level-grid">
            <div class="level-btn" onclick="selectLevel('Level1')">Level 1</div>
            <div class="level-btn" onclick="selectLevel('Level2')">Level 2</div>
            <div class="level-btn" onclick="selectLevel('Level3')">Level 3</div>
            <div class="level-btn" onclick="selectLevel('Level4')">Level 4</div>
            <div class="level-btn" onclick="selectLevel('Level5')">Level 5</div>
            <div class="level-btn" onclick="selectLevel('Level6')">Level 6</div>
          </div>
        </div>

        <!-- ATTENDANCE SECTION -->
        <div id="attendanceSection" style="display:none;">
          <h4>Mark Attendance for <span id="currentLevelDisplay"></span></h4>
          <button id="backBtn" class="mdl-button mdl-js-button mdl-button--raised">â¬… Back</button>
          <div id="statusMessage"></div>
          <div id="studentList"></div>
          <button id="submitBtn" class="mdl-button mdl-js-button mdl-button--raised mdl-button--accent submit-btn">
            Submit Attendance
          </button>
        </div>
      </div>
    </main>
  </div>

  <script>
    const CLIENT_ID = "1062324886633-brv79jb9smbkrpd9iuvtj5galvhbqfqh.apps.googleusercontent.com";
    const SPREADSHEET_ID = "1qnNF6HZXxWksMjJ-Z06Ovk64CWMvXFHeTieaTi8xZ5M";
    const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

    let tokenClient;
    let attendance = {};
    let teacherName = "";
    let currentLevel = "";

    gapi.load("client", async () => {
      await gapi.client.init({
        discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
      });
    });

    window.onload = () => {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: async (resp) => {
          if (resp.error !== undefined) {
            console.error(resp);
            showStatus("OAuth Error", false);
            return;
          }

          teacherName = "Teacher";
          document.getElementById("teacherNameDisplay").textContent = teacherName;

          document.getElementById("loginBtn").style.display = "none";
          document.getElementById("levelSelector").style.display = "block";
        },
      });

      document.getElementById("loginBtn").onclick = () => {
        tokenClient.requestAccessToken({ prompt: "consent" });
      };

      document.getElementById("submitBtn").onclick = submitAttendance;
      document.getElementById("backBtn").onclick = goBack;
    };

    function selectLevel(level) {
      currentLevel = level;
      document.getElementById("levelSelector").style.display = "none";
      document.getElementById("attendanceSection").style.display = "block";
      document.getElementById("currentLevelDisplay").textContent = level;
      loadStudents();
    }

    function goBack() {
      document.getElementById("attendanceSection").style.display = "none";
      document.getElementById("levelSelector").style.display = "block";
      document.getElementById("studentList").innerHTML = "";
      attendance = {};
      currentLevel = "";
    }

    async function loadStudents() {
      try {
        const response = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: `${currentLevel}!A2:A`,
        });

        const students = response.result.values ? response.result.values.flat() : [];
        renderStudents(students);
      } catch (err) {
        console.error("Error loading students:", err);
        showStatus("Error loading students", false);
      }
    }

    function renderStudents(students) {
      const listDiv = document.getElementById("studentList");
      listDiv.innerHTML = "";

      students.forEach((student) => {
        attendance[student] = "Absent";

        const div = document.createElement("div");
        div.className = "student-card mdl-shadow--2dp";

        const radios = `
          <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="present-${student}">
            <input type="radio" id="present-${student}" class="mdl-radio__button" name="${student}" value="Present"
              onchange="mark('${student}', 'Present')" />
            <span class="mdl-radio__label">Present</span>
          </label>
          <label class="mdl-radio mdl-js-radio mdl-js-ripple-effect" for="absent-${student}">
            <input type="radio" id="absent-${student}" class="mdl-radio__button" name="${student}" value="Absent"
              checked onchange="mark('${student}', 'Absent')" />
            <span class="mdl-radio__label">Absent</span>
          </label>
        `;

        div.innerHTML = `<span class="student-name">${student}</span><div>${radios}</div>`;
        listDiv.appendChild(div);
        componentHandler.upgradeElements(div);
      });
    }

    function mark(student, status) {
      attendance[student] = status;
    }

    function showStatus(msg, success = true) {
      const status = document.getElementById("statusMessage");
      status.textContent = msg;
      status.style.color = success ? "var(--accent-color)" : "var(--error-color)";
      setTimeout(() => {
        status.textContent = "";
      }, 3000);
    }

    async function submitAttendance() {
      try {
        const students = Object.keys(attendance);
        for (let i = 0; i < students.length; i++) {
          const student = students[i];
          await gapi.client.sheets.spreadsheets.values.update({
            spreadsheetId: SPREADSHEET_ID,
            range: `${currentLevel}!B${i + 2}`,
            valueInputOption: "RAW",
            resource: { values: [[attendance[student]]] },
          });
        }
        showStatus("Attendance submitted!");
      } catch (err) {
        console.error(err);
        showStatus("Error submitting attendance", false);
      }
    }
  </script>
</body>
</html>
