<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Baladatta Tamil School Attendance</title>

  <!-- Material Design Lite -->
  <link rel="stylesheet" href="https://code.getmdl.io/1.3.0/material.indigo-pink.min.css">
  <script defer src="https://code.getmdl.io/1.3.0/material.min.js"></script>

  <!-- Google Identity & API -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <script src="https://apis.google.com/js/api.js"></script>

  <style>
    :root {
      --accent: #ff6e4a ;
      --present: #4caf50;
      --absent: #ff4c4c;
      --card-bg: #121212;
      --text: #ffffff;
    }

    body {
      margin: 0;
      font-family: 'Inter', sans-serif;
      color: var(--text);
      background: linear-gradient(180deg, #0b0b0b, #1a1a1a);
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
    }

    body::before {
      content: '';
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background-image: 
        repeating-linear-gradient(
          135deg,
          rgba(255,140,75,0.05) 0px,
          rgba(255,140,75,0.05) 3px,
          transparent 3px,
          transparent 15px
        );
      pointer-events: none;
      z-index: 0;
    }

    header {
      background: #0d0d0d;
      padding: 16px 20px;
      box-shadow: 0 4px 12px rgba(255,140,75,0.2);
      font-size: 20px;
      font-weight: bold;
      text-align: center;
      width: 100%;
      position: relative;
      z-index: 1;
    }

    .page-content {
      padding: 20px;
      max-width: 800px;
      width: 100%;
      margin: 40px auto;
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .student-card {
      background: var(--card-bg);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }

    .student-name {
      font-weight: bold;
    }

    #statusMessage {
      margin: 10px 0;
      font-weight: bold;
    }

    button.mdl-button, .custom-login-btn, .level-btn, #submitBtn, #backBtn, #addStudentBtn {
      background: #1a1a1a !important;
      color: var(--accent) !important;
      border: 2px solid var(--accent);
      border-radius: 8px;
      padding: 12px 20px;
      margin: 8px;
      font-size: 16px;
      cursor: pointer;
      transition: 0.3s;
    }
    button.mdl-button:hover, .custom-login-btn:hover, .level-btn:hover, #submitBtn:hover, #backBtn:hover, #addStudentBtn:hover {
      background: var(--accent) !important;
      color: #000 !important;
    }
    button:active {
      transform: scale(0.96);
    }

    /* Custom Google Sign-In */
    .custom-login-btn {
      display: block;
      margin: 60px auto 20px auto;
    }

    /* Toggle Switch */
    .toggle-switch {
      position: relative;
      width: 60px;
      height: 28px;
      display: inline-block;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
    }
    .slider {
      position: absolute;
      cursor: pointer;
      background-color: var(--absent);
      border-radius: 28px;
      top: 0; left: 0; right: 0; bottom: 0;
      transition: 0.4s;
    }
    .slider:before {
      position: absolute;
      content: "";
      height: 22px;
      width: 22px;
      left: 3px;
      bottom: 3px;
      background-color: #fff;
      border-radius: 50%;
      transition: 0.4s;
    }
    input:checked + .slider {
      background-color: var(--present);
    }
    input:checked + .slider:before {
      transform: translateX(32px);
    }

    .add-student-container {
      margin-top: 20px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      width: 100%;
    }
    .add-student-container input {
      flex: 1;
      padding: 8px;
      border-radius: 6px;
      border: none;
      outline: none;
      background: #1e1e1e;
      color: #fff;
    }
    
  </style>
</head>
<body>
  <header>Baladatta Tamil School Attendance</header>

  <div class="page-content">
    <button id="loginBtn" class="custom-login-btn">Sign in with Google</button>

    <div id="levelSelection" style="display:none;">
      <h3>Select Your Level</h3>
      <div id="levelButtons"></div>
    </div>

    <div id="attendanceSection" style="display:none;">
      <button id="backBtn">‚Üê Back</button>
      <p>Logged in as: <span id="teacherNameDisplay"></span></p>
      <h4>Mark Attendance</h4>
      <div id="statusMessage"></div>
      <div id="studentList"></div>

      <div class="add-student-container">
        <input type="text" id="newStudentName" placeholder="Enter new student name" />
        <button id="addStudentBtn">Add Student</button>
      </div>

      <button id="submitBtn">Submit Attendance</button>
    </div>
  </div>

  <script>
    const CLIENT_ID = "1062324886633-brv79jb9smbkrpd9iuvtj5galvhbqfqh.apps.googleusercontent.com";
    const SPREADSHEET_ID = "1qnNF6HZXxWksMjJ-Z06Ovk64CWMvXFHeTieaTi8xZ5M";
    const SCOPES = "https://www.googleapis.com/auth/spreadsheets";
    const LEVELS = ["Level1","Level2","Level3","Level4","Level5","Level6"];

    let tokenClient;
    let attendance = {};
    let teacherName = "";
    let TEACHER_LEVEL = "";

    const levelButtonsDiv = document.getElementById("levelButtons");
    const backBtn = document.getElementById("backBtn");
    const studentList = document.getElementById("studentList");

    gapi.load("client", async () => {
      await gapi.client.init({
        discoveryDocs: ["https://sheets.googleapis.com/$discovery/rest?version=v4"],
      });
    });

    window.onload = () => {
      tokenClient = google.accounts.oauth2.initTokenClient({
        client_id: CLIENT_ID,
        scope: SCOPES,
        callback: async (resp) => {
          if(resp.error !== undefined){ console.error(resp); showStatus("OAuth Error",false); return; }
          teacherName = "Teacher";
          document.getElementById("teacherNameDisplay").textContent = teacherName;
          document.getElementById("loginBtn").style.display="none";
          document.getElementById("levelSelection").style.display="block";
          renderLevels();
        }
      });

      document.getElementById("loginBtn").onclick = () => tokenClient.requestAccessToken({ prompt:"consent" });
      backBtn.onclick = () => {
        document.getElementById("attendanceSection").style.display="none";
        document.getElementById("levelSelection").style.display="block";
        studentList.innerHTML="";
      };
      document.getElementById("submitBtn").onclick = submitAttendance;
      document.getElementById("addStudentBtn").onclick = addStudent;
    };

    function renderLevels(){
      levelButtonsDiv.innerHTML="";
      LEVELS.forEach(lvl=>{
        const btn=document.createElement("button");
        btn.className="level-btn";
        btn.textContent=lvl;
        btn.onclick=()=>selectLevel(lvl);
        levelButtonsDiv.appendChild(btn);
      });
    }

    async function selectLevel(level){
      TEACHER_LEVEL=level;
      document.getElementById("levelSelection").style.display="none";
      document.getElementById("attendanceSection").style.display="block";
      studentList.innerHTML="";
      attendance={};
      await loadStudents();
    }

    async function loadStudents(){
      try{
        const response = await gapi.client.sheets.spreadsheets.values.get({
          spreadsheetId: SPREADSHEET_ID,
          range: `${TEACHER_LEVEL}!A2:A`
        });
        const students=response.result.values?response.result.values.flat():[];
        renderStudents(students);
      }catch(err){console.error(err); showStatus("Error loading students",false);}
    }

    function renderStudents(students){
      studentList.innerHTML="";
      students.forEach(student=>{
        attendance[student]="Absent";
        const div=document.createElement("div");
        div.className="student-card";
        div.innerHTML=`<span class="student-name">${student}</span>
        <label class="toggle-switch">
          <input type="checkbox" onchange="mark('${student}',this.checked)">
          <span class="slider"></span>
        </label>`;
        studentList.appendChild(div);
      });
    }

    function mark(student,isPresent){attendance[student]=isPresent?"Present":"Absent";}

    function showStatus(msg,success=true){
      const status=document.getElementById("statusMessage");
      status.textContent=msg;
      status.style.color=success?"var(--present)":"var(--absent)";
      setTimeout(()=>{status.textContent="";},3000);
    }

    async function submitAttendance(){
      try{
        const students=Object.keys(attendance);
        const date=(new Date()).toLocaleDateString();
        for(let i=0;i<students.length;i++){
          const student=students[i];
          // Update level sheet
          await gapi.client.sheets.spreadsheets.values.update({
            spreadsheetId:SPREADSHEET_ID,
            range:`${TEACHER_LEVEL}!B${i+2}`,
            valueInputOption:"RAW",
            resource:{values:[[attendance[student]]]}
          });
          // Append to logs
          await gapi.client.sheets.spreadsheets.values.append({
            spreadsheetId: SPREADSHEET_ID,
            range: `Logs!A1`,
            valueInputOption: "RAW",
            resource: { values: [[student, date, teacherName, attendance[student], TEACHER_LEVEL]] },
          });

        }
        showStatus("Attendance submitted!");
      }catch(err){console.error(err); showStatus("Error submitting attendance",false);}
    }

    async function addStudent(){
      const newName=document.getElementById("newStudentName").value.trim();
      if(!newName)return alert("Enter student name");
      try{
        await gapi.client.sheets.spreadsheets.values.append({
          spreadsheetId:SPREADSHEET_ID,
          range:`${TEACHER_LEVEL}!A1`,
          valueInputOption:"RAW",
          resource:{values:[[newName]]}
        });
        document.getElementById("newStudentName").value="";
        loadStudents();
        showStatus("Student added!");
      }catch(err){console.error(err); showStatus("Error adding student",false);}
    }
  </script>
</body>
</html>
